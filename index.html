<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Attendance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg border-b-4 border-blue-500">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-800">📚 Student Attendance</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="showPage('home')" class="px-4 py-2 text-blue-600 hover:text-blue-800 font-medium transition-colors">Utama</button>
                    <button onclick="showAdminLogin()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Admin</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Home Page -->
    <div id="homePage" class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Professional Header -->
            <div class="text-center mb-12">
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-2xl p-8 mb-8 shadow-xl">
                    <div class="text-6xl mb-4">🎓</div>
                    <h2 class="text-4xl font-bold mb-4">Student Attendance System</h2>
                    <p class="text-xl text-blue-100">Sistem Kehadiran Pelajar Digital</p>
                    <div class="mt-6 flex justify-center items-center space-x-6 text-sm">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-green-400 rounded-full mr-2"></div>
                            <span>Secure & Reliable</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-yellow-400 rounded-full mr-2"></div>
                            <span>Real-time Tracking</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-pink-400 rounded-full mr-2"></div>
                            <span>Easy to Use</span>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-2">Mark Your Attendance</h3>
                    <p class="text-gray-600">Please select date and course code to record your attendance</p>
                </div>
            </div>

            <!-- Form Status Message -->
            <div id="formClosedMessage" class="bg-red-50 border border-red-200 rounded-xl p-8 mb-8 text-center hidden">
                <div class="mb-6">
                    <div class="text-6xl mb-4">🚫</div>
                    <h3 class="text-2xl font-bold text-red-800 mb-4">Attendance Register is Closed</h3>
                    <p class="text-red-700 text-lg mb-6">
                        Attendance register is closed for the day.<br>
                        Please contact your lecturer for assistance.
                    </p>
                </div>
                
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">Contact Lecturer</h4>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                        <div class="text-gray-700">
                            <strong>Puan Zubaidah</strong>
                        </div>
                        <div class="flex gap-3">
                            <a href="https://wa.me/60123812146" target="_blank" rel="noopener noreferrer" 
                               class="flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                                </svg>
                                WhatsApp
                            </a>
                            <a href="https://t.me/+60123812146" target="_blank" rel="noopener noreferrer"
                               class="flex items-center gap-2 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                                </svg>
                                Telegram
                            </a>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mt-3">0123812146</p>
                </div>
            </div>

            <div id="attendanceForm" class="bg-white rounded-2xl shadow-2xl p-8 mb-8 border border-gray-100">
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <div class="space-y-3">
                        <div class="flex items-center space-x-2">
                            <div class="text-2xl">📅</div>
                            <h3 class="text-xl font-semibold text-gray-800">Select Date</h3>
                        </div>
                        <input type="date" id="homeDateSelect" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 hover:bg-white">
                    </div>
                    <div class="space-y-3">
                        <div class="flex items-center space-x-2">
                            <div class="text-2xl">📚</div>
                            <h3 class="text-xl font-semibold text-gray-800">Select Course</h3>
                        </div>
                        <select id="homeCourseSelect" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 hover:bg-white">
                            <option value="">Choose your course...</option>
                            <option value="MAT455">MAT455 - Matematik Lanjutan</option>
                            <option value="MAT565">MAT565 - Statistik Terapan</option>
                        </select>
                    </div>
                </div>
                <button onclick="proceedToCourse()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 px-8 rounded-xl hover:from-blue-700 hover:to-purple-700 transition-all duration-200 font-semibold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                    <span class="flex items-center justify-center space-x-2">
                        <span>Continue to Attendance</span>
                        <span>→</span>
                    </span>
                </button>
            </div>


        </div>
    </div>

    <!-- Course Page -->
    <div id="coursePage" class="container mx-auto px-4 py-8 hidden">
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <button onclick="showPage('home')" class="mb-4 text-blue-600 hover:text-blue-800 flex items-center">
                    ← Kembali ke Utama
                </button>
                <h2 id="courseTitle" class="text-3xl font-bold text-gray-800 mb-6"></h2>
                
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h3 class="text-xl font-semibold mb-4">Tarikh Dipilih</h3>
                        <div id="selectedDate" class="p-3 bg-gray-100 rounded-lg text-gray-700 font-medium"></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-4">Pilih Masa</h3>
                        <select id="timeSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Pilih Masa...</option>
                        </select>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-4">Pilih Kumpulan</h3>
                    <select id="groupSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Pilih Kumpulan...</option>
                    </select>
                </div>

                <div id="attendanceSection" class="hidden">
                    <h3 class="text-xl font-semibold mb-4">Pilih Nama Pelajar</h3>
                    <div class="space-y-4">
                        <select id="studentSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Pilih Nama Pelajar...</option>
                        </select>
                        <button type="button" onclick="markAttendance()" class="w-full bg-green-600 text-white py-3 px-6 rounded-lg hover:bg-green-700 transition-colors font-semibold">
                            SUBMIT
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Login Admin</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password:</label>
                    <input type="password" id="adminPassword" placeholder="Masukkan password admin" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex space-x-4">
                    <button onclick="loginAdmin()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors">Login</button>
                    <button onclick="closeAdminLogin()" class="flex-1 bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-700 transition-colors">Batal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center flex items-center justify-center">
                🔐 <span class="ml-2">Change Admin Password</span>
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Current Password:</label>
                    <input type="password" id="currentPassword" placeholder="Enter current password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">New Password:</label>
                    <input type="password" id="newPassword" placeholder="Enter new password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password:</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm new password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex space-x-4">
                    <button onclick="changePassword()" class="flex-1 bg-orange-600 text-white py-3 rounded-lg hover:bg-orange-700 transition-colors font-semibold">Update Password</button>
                    <button onclick="closeChangePassword()" class="flex-1 bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-700 transition-colors">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Page -->
    <div id="adminPage" class="container mx-auto px-4 py-8 hidden">
        <div class="max-w-6xl mx-auto">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <button onclick="showPage('home')" class="mb-4 text-blue-600 hover:text-blue-800 flex items-center">
                            ← Kembali ke Utama
                        </button>
                        <h2 class="text-3xl font-bold text-gray-800">Panel Admin</h2>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-600">Attendance Form:</span>
                        <button id="toggleFormBtn" onclick="toggleAttendanceForm()" class="px-4 py-2 rounded-lg font-semibold transition-colors">
                        </button>
                        <button onclick="showChangePassword()" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-semibold">
                            🔐 Change Password
                        </button>
                    </div>
                </div>



                <!-- Filter Statistics Section -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 mb-6 border border-blue-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        🔍 <span class="ml-2">Filter Statistics</span>
                    </h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Course:</label>
                            <select id="filterCourse" onchange="updateGroupStats()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">All Courses</option>
                                <option value="MAT455">MAT455</option>
                                <option value="MAT565">MAT565</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Group:</label>
                            <select id="filterGroup" onchange="updateGroupStats()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">All Groups</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Group Statistics Section -->
                <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 mb-6 border border-purple-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        👥 <span class="ml-2">Group Statistics</span>
                    </h3>
                    <div id="groupStatsContainer">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                </div>

                <!-- Management Dashboard -->
                <div class="bg-gradient-to-r from-green-50 to-teal-50 rounded-xl p-6 mb-8 border border-green-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                        📊 <span class="ml-2">Management Dashboard</span>
                    </h3>
                    
                    <!-- Statistics Grid -->
                    <div class="grid md:grid-cols-3 gap-6">
                        <!-- Overall Stats -->
                        <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-blue-500">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                                📈 <span class="ml-2">Overall Stats</span>
                            </h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Total Students:</span>
                                    <span class="font-bold text-blue-600" id="totalStudents">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Today's Attendance:</span>
                                    <span class="font-bold text-green-600" id="todayAttendance">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Attendance Rate:</span>
                                    <span class="font-bold text-purple-600" id="attendancePercentage">0%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Student Lookup -->
                        <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-green-500">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                                👤 <span class="ml-2">Student Lookup</span>
                            </h4>
                            <div class="space-y-2">
                                <select id="studentGroupFilter" onchange="updateStudentList()" class="w-full p-2 border border-gray-300 rounded-lg text-xs">
                                    <option value="">All Groups</option>
                                </select>
                                <div class="flex space-x-1">
                                    <input type="text" id="studentSearchInput" placeholder="Search student..." class="flex-1 p-2 border border-gray-300 rounded-lg text-xs" onkeyup="searchStudent(event)">
                                    <button onclick="clearSearch()" class="px-2 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-xs">×</button>
                                </div>
                                <select id="studentFilter" onchange="updateStudentStats()" class="w-full p-2 border border-gray-300 rounded-lg text-xs">
                                    <option value="">Select Student...</option>
                                </select>
                                <div id="studentStatsDisplay" class="hidden bg-gray-50 rounded p-2">
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span>Group:</span>
                                            <span class="font-semibold" id="studentGroup">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Attendance:</span>
                                            <span class="font-semibold text-green-600" id="studentAttendanceCount">0</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Rate:</span>
                                            <span class="font-bold text-orange-600" id="studentAttendancePercentage">0%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Google Sheets Integration -->
                        <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-purple-500">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                                📊 <span class="ml-2">Google Sheets</span>
                            </h4>
                            <div class="space-y-2">
                                <input type="url" id="sheetsUrl" placeholder="Google Sheets CSV URL..." value="https://docs.google.com/spreadsheets/d/e/2PACX-1vTjrDTFHjwR-MNicW7RftQh1jLSGkz3MezCPHQW-u9jKJafKnA_4D9oaGemHyMhHopnFvWkUyYN1oem/pub?gid=0&single=true&output=csv" class="w-full p-2 border border-gray-300 rounded-lg text-xs">
                                <div class="flex space-x-1">
                                    <button onclick="loadStudentsFromSheets()" class="flex-1 bg-blue-600 text-white py-2 px-2 rounded-lg hover:bg-blue-700 transition-colors font-semibold text-xs">
                                        📥 Load Students
                                    </button>
                                    <button onclick="exportToSheets()" class="flex-1 bg-green-600 text-white py-2 px-2 rounded-lg hover:bg-green-700 transition-colors font-semibold text-xs">
                                        📤 Export Data
                                    </button>
                                </div>
                                <div id="sheetsStatus" class="text-xs text-gray-500 hidden"></div>
                                <details class="text-xs">
                                    <summary class="cursor-pointer text-blue-600 hover:text-blue-800">Setup Instructions</summary>
                                    <div class="mt-2 p-2 bg-gray-50 rounded text-gray-700">
                                        <p class="font-semibold mb-1">Format Google Sheets:</p>
                                        <p>Column A: Group (EMD3M3C)</p>
                                        <p>Column B: Student Name</p>
                                        <p class="mt-1 font-semibold">Get CSV URL:</p>
                                        <p>File → Share → Publish to web → CSV</p>
                                    </div>
                                </details>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">📋 Rekod Kehadiran Terperinci</h3>
                    
                    <!-- Filter Section for Records -->
                    <div class="bg-white rounded-lg p-4 mb-6 border border-gray-200">
                        <h4 class="text-lg font-semibold text-gray-700 mb-4">🔍 Filter Rekod Kehadiran</h4>
                        <div class="grid md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kursus:</label>
                                <select id="recordFilterCourse" onchange="updateRecordFilters()" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="">Semua Kursus</option>
                                    <option value="MAT455">MAT455</option>
                                    <option value="MAT565">MAT565</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kumpulan:</label>
                                <select id="recordFilterGroup" onchange="updateRecordsTable()" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="">Semua Kumpulan</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Masa:</label>
                                <select id="recordFilterTime" onchange="updateRecordsTable()" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="">Semua Masa</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tarikh:</label>
                                <input type="date" id="recordFilterDate" onchange="updateRecordsTable()" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                        </div>
                        <div class="flex space-x-4">
                            <button onclick="clearRecordFilters()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm">
                                Clear Filters
                            </button>
                            <button onclick="exportFilteredRecords()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                Export Filtered Data
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <div id="recordsTableContainer">
                            <div class="text-center py-8 text-gray-500">
                                <p class="text-lg">🔍 Sila pilih filter untuk melihat rekod kehadiran</p>
                                <p class="text-sm mt-2">Gunakan dropdown di atas untuk filter mengikut kursus, kumpulan, masa atau tarikh</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data structure
        const courseData = {
            'MAT455': {
                name: 'MAT455 - Matematik Lanjutan',
                groups: ['EMD3M3C', 'EMD3M8C'],
                schedule: ['10:00-12:00', '14:00-16:00']
            },
            'MAT565': {
                name: 'MAT565 - Statistik Terapan',
                groups: ['EMD4M1D', 'EMD4M2R'],
                schedule: ['08:00-10:00', '16:00-18:00']
            }
        };

        // Student data - can be loaded from Google Sheets
        let studentData = JSON.parse(localStorage.getItem('studentData')) || {
            'EMD3M3C': ['Ahmad Bin Ali', 'Siti Nurhaliza', 'Muhammad Faiz', 'Nurul Ain', 'Hafiz Rahman'],
            'EMD3M8C': ['Fatimah Zahra', 'Omar Abdullah', 'Zainab Mohd', 'Iskandar Shah', 'Mariam Yusof'],
            'EMD4M1D': ['Ali Hassan', 'Khadijah Ahmad', 'Yusuf Ibrahim', 'Aminah Salleh', 'Rashid Mahmud'],
            'EMD4M2R': ['Hakim Razak', 'Safiyyah Osman', 'Tariq Nasir', 'Layla Hashim', 'Bilal Karim']
        };

        // State management
        let currentCourse = '';
        let currentGroup = '';
        let currentTime = '';
        let currentDate = '';
        let attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
        let dailyAttendance = JSON.parse(localStorage.getItem('dailyAttendance')) || {};
        let formEnabled = JSON.parse(localStorage.getItem('formEnabled')) ?? true;
        let adminPassword = localStorage.getItem('adminPassword') || 'admin123';

        // Initialize
        function init() {
            updateFormStatus();
            updateHomePageDisplay();
            showPage('home');
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('homeDateSelect').value = today;
        }

        function updateHomePageDisplay() {
            const formClosedMessage = document.getElementById('formClosedMessage');
            const attendanceForm = document.getElementById('attendanceForm');
            
            if (formEnabled) {
                formClosedMessage.classList.add('hidden');
                attendanceForm.classList.remove('hidden');
            } else {
                formClosedMessage.classList.remove('hidden');
                attendanceForm.classList.add('hidden');
            }
        }

        // Page navigation
        function showPage(page) {
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('coursePage').classList.add('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            
            if (page === 'home') {
                document.getElementById('homePage').classList.remove('hidden');
            } else if (page === 'course') {
                document.getElementById('coursePage').classList.remove('hidden');
            } else if (page === 'admin') {
                document.getElementById('adminPage').classList.remove('hidden');
                updateAdminStats();
                updateGroupStats();
            }
        }

        // Home page functions
        function proceedToCourse() {
            const selectedDate = document.getElementById('homeDateSelect').value;
            const selectedCourse = document.getElementById('homeCourseSelect').value;
            
            if (!selectedDate) {
                alert('Sila pilih tarikh.');
                return;
            }
            
            if (!selectedCourse) {
                alert('Sila pilih kod kursus.');
                return;
            }
            
            if (!formEnabled) {
                alert('Borang kehadiran sedang ditutup oleh admin.');
                return;
            }
            
            currentCourse = selectedCourse;
            currentDate = selectedDate;
            
            setupCoursePage();
            showPage('course');
        }

        function setupCoursePage() {
            document.getElementById('courseTitle').textContent = courseData[currentCourse].name;
            document.getElementById('selectedDate').textContent = new Date(currentDate).toLocaleDateString('ms-MY', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Populate time options
            const timeSelect = document.getElementById('timeSelect');
            timeSelect.innerHTML = '<option value="">Pilih Masa...</option>';
            courseData[currentCourse].schedule.forEach(time => {
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                timeSelect.appendChild(option);
            });
            
            // Populate group options
            const groupSelect = document.getElementById('groupSelect');
            groupSelect.innerHTML = '<option value="">Pilih Kumpulan...</option>';
            courseData[currentCourse].groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                groupSelect.appendChild(option);
            });
            
            // Reset selections
            document.getElementById('attendanceSection').classList.add('hidden');
            currentGroup = '';
            currentTime = '';
        }

        // Event listeners for course page
        document.getElementById('timeSelect').addEventListener('change', function() {
            currentTime = this.value;
            checkShowAttendance();
        });

        document.getElementById('groupSelect').addEventListener('change', function() {
            currentGroup = this.value;
            checkShowAttendance();
        });

        function checkShowAttendance() {
            if (currentGroup && currentTime) {
                showAttendanceSection();
            }
        }

        function showAttendanceSection() {
            const section = document.getElementById('attendanceSection');
            section.classList.remove('hidden');
            section.classList.add('fade-in');
            
            populateStudentList();
        }

        function populateStudentList() {
            const studentSelect = document.getElementById('studentSelect');
            studentSelect.innerHTML = '<option value="">Pilih Nama Pelajar...</option>';
            
            const attendanceKey = `${currentCourse}-${currentGroup}-${currentTime}-${currentDate}`;
            const dayAttended = dailyAttendance[attendanceKey] || [];
            
            const availableStudents = studentData[currentGroup].filter(student => 
                !dayAttended.includes(student)
            );
            
            availableStudents.forEach(student => {
                const option = document.createElement('option');
                option.value = student;
                option.textContent = student;
                studentSelect.appendChild(option);
            });
        }

        function markAttendance() {
            const studentSelect = document.getElementById('studentSelect');
            const selectedStudent = studentSelect.value;
            
            if (!selectedStudent) {
                alert('Sila pilih nama pelajar.');
                return;
            }
            
            const attendanceKey = `${currentCourse}-${currentGroup}-${currentTime}-${currentDate}`;
            
            // Initialize daily attendance for this key if not exists
            if (!dailyAttendance[attendanceKey]) {
                dailyAttendance[attendanceKey] = [];
            }
            
            // Add to daily attendance
            dailyAttendance[attendanceKey].push(selectedStudent);
            
            // Add to records
            attendanceRecords.push({
                course: currentCourse,
                group: currentGroup,
                student: selectedStudent,
                time: currentTime,
                date: currentDate,
                timestamp: new Date().toISOString()
            });
            
            // Save to localStorage
            localStorage.setItem('dailyAttendance', JSON.stringify(dailyAttendance));
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            
            // Show success message and redirect to home
            alert(`Thank you ${selectedStudent} for marking your attendance today. Stay focused and keep up the good work! 🎓✨`);
            
            // Navigate back to home page
            setTimeout(() => {
                showPage('home');
                // Reset form
                document.getElementById('homeCourseSelect').value = '';
            }, 1000);
        }

        // Admin functions
        function showAdminLogin() {
            document.getElementById('adminLoginModal').classList.remove('hidden');
            document.getElementById('adminPassword').focus();
        }

        function closeAdminLogin() {
            document.getElementById('adminLoginModal').classList.add('hidden');
            document.getElementById('adminPassword').value = '';
        }

        function loginAdmin() {
            const password = document.getElementById('adminPassword').value;
            
            if (password === adminPassword) {
                closeAdminLogin();
                showPage('admin');
            } else {
                alert('Password salah! Sila cuba lagi.');
                document.getElementById('adminPassword').value = '';
            }
        }

        // Allow Enter key to login
        document.getElementById('adminPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loginAdmin();
            }
        });

        // Change Password Functions
        function showChangePassword() {
            document.getElementById('changePasswordModal').classList.remove('hidden');
            document.getElementById('currentPassword').focus();
        }

        function closeChangePassword() {
            document.getElementById('changePasswordModal').classList.add('hidden');
            // Clear all password fields
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        function changePassword() {
            const currentPass = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;

            // Validate current password
            if (currentPass !== adminPassword) {
                alert('Current password is incorrect!');
                document.getElementById('currentPassword').focus();
                return;
            }

            // Validate new password
            if (!newPass) {
                alert('Please enter a new password!');
                document.getElementById('newPassword').focus();
                return;
            }

            if (newPass.length < 6) {
                alert('New password must be at least 6 characters long!');
                document.getElementById('newPassword').focus();
                return;
            }

            // Validate password confirmation
            if (newPass !== confirmPass) {
                alert('New password and confirmation do not match!');
                document.getElementById('confirmPassword').focus();
                return;
            }

            // Update password
            adminPassword = newPass;
            localStorage.setItem('adminPassword', adminPassword);
            
            alert('Password changed successfully! 🎉');
            closeChangePassword();
        }

        // Allow Enter key for password change
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !document.getElementById('changePasswordModal').classList.contains('hidden')) {
                changePassword();
            }
        });

        function toggleAttendanceForm() {
            formEnabled = !formEnabled;
            localStorage.setItem('formEnabled', JSON.stringify(formEnabled));
            updateFormStatus();
            updateHomePageDisplay();
        }

        function updateFormStatus() {
            const btn = document.getElementById('toggleFormBtn');
            if (formEnabled) {
                btn.textContent = 'AKTIF';
                btn.className = 'px-4 py-2 rounded-lg font-semibold transition-colors bg-green-600 text-white hover:bg-green-700';
            } else {
                btn.textContent = 'TUTUP';
                btn.className = 'px-4 py-2 rounded-lg font-semibold transition-colors bg-red-600 text-white hover:bg-red-700';
            }
        }

        // Google Sheets Integration Functions
        function loadStudentsFromSheets() {
            const sheetsUrl = document.getElementById('sheetsUrl').value;
            const statusDiv = document.getElementById('sheetsStatus');
            
            if (!sheetsUrl) {
                alert('Sila masukkan Google Sheets CSV URL terlebih dahulu.');
                return;
            }
            
            // More flexible URL validation for published sheets
            if (!sheetsUrl.includes('docs.google.com')) {
                alert('URL tidak sah. Sila gunakan CSV export URL dari Google Sheets.');
                return;
            }
            
            statusDiv.classList.remove('hidden');
            statusDiv.textContent = '⏳ Loading students from Google Sheets...';
            statusDiv.className = 'text-xs text-blue-600';
            
            console.log('Fetching from URL:', sheetsUrl);
            
            // Fetch data from Google Sheets
            fetch(sheetsUrl)
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(csvData => {
                    console.log('CSV Data received:', csvData.substring(0, 200) + '...');
                    
                    const newStudentData = parseCSVToStudentData(csvData);
                    console.log('Parsed student data:', newStudentData);
                    
                    if (Object.keys(newStudentData).length === 0) {
                        throw new Error('No valid student data found in the sheet. Please check format: Column A = Group, Column B = Student Name');
                    }
                    
                    // Backup current data
                    const backupData = JSON.stringify(studentData);
                    localStorage.setItem('studentDataBackup', backupData);
                    
                    // Replace student data completely (not merge)
                    studentData = {...newStudentData};
                    
                    // Save to localStorage
                    localStorage.setItem('studentData', JSON.stringify(studentData));
                    
                    // Update UI immediately
                    updateAdminStats();
                    updateGroupStats();
                    updateStudentFilter();
                    
                    // Show success message
                    const totalStudents = Object.values(newStudentData).reduce((sum, students) => sum + students.length, 0);
                    const totalGroups = Object.keys(newStudentData).length;
                    
                    statusDiv.textContent = `✅ Successfully loaded ${totalStudents} students from ${totalGroups} groups`;
                    statusDiv.className = 'text-xs text-green-600';
                    
                    console.log(`Loaded ${totalStudents} students from ${totalGroups} groups`);
                    
                    alert(`🎉 Data berjaya dimuat!\n\n📊 ${totalStudents} pelajar dari ${totalGroups} kumpulan telah dikemas kini.\n\nTotal Students: ${totalStudents}\nGroups: ${Object.keys(newStudentData).join(', ')}`);
                })
                .catch(error => {
                    console.error('Error loading from Google Sheets:', error);
                    statusDiv.textContent = `❌ Error: ${error.message}`;
                    statusDiv.className = 'text-xs text-red-600';
                    
                    alert(`❌ Gagal memuat data dari Google Sheets.\n\nError: ${error.message}\n\nPastikan:\n1. URL adalah CSV export link yang betul\n2. Sheet boleh diakses secara public\n3. Format data: Column A = Group Code, Column B = Student Name`);
                });
        }
        
        function parseCSVToStudentData(csvData) {
            const lines = csvData.trim().split('\n');
            const newStudentData = {};
            let processedRows = 0;
            
            lines.forEach((line, index) => {
                // Skip empty lines
                if (!line.trim()) return;
                
                // Parse CSV line (handle commas in names)
                const columns = parseCSVLine(line);
                
                if (columns.length >= 2) {
                    const group = columns[0].trim();
                    const studentName = columns[1].trim();
                    
                    // Validate group and student name
                    if (group && studentName) {
                        if (!newStudentData[group]) {
                            newStudentData[group] = [];
                        }
                        
                        // Avoid duplicates
                        if (!newStudentData[group].includes(studentName)) {
                            newStudentData[group].push(studentName);
                            processedRows++;
                        }
                    }
                }
            });
            
            console.log(`Processed ${processedRows} student records from ${Object.keys(newStudentData).length} groups`);
            return newStudentData;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }
        
        function restoreStudentDataBackup() {
            const backup = localStorage.getItem('studentDataBackup');
            if (backup) {
                const backupData = JSON.parse(backup);
                Object.assign(studentData, backupData);
                localStorage.setItem('studentData', JSON.stringify(studentData));
                updateAdminStats();
                updateGroupStats();
                updateStudentFilter();
                alert('Student data restored from backup.');
            } else {
                alert('No backup data found.');
            }
        }

        function updateAdminStats() {
            const todayKey = new Date().toISOString().split('T')[0];
            let totalStudents = 0;
            let todayAttendanceCount = 0;
            
            // Count total students
            Object.values(studentData).forEach(students => {
                totalStudents += students.length;
            });
            
            // Count today's attendance
            Object.keys(dailyAttendance).forEach(key => {
                if (key.includes(todayKey)) {
                    todayAttendanceCount += dailyAttendance[key].length;
                }
            });
            
            const percentage = totalStudents > 0 ? Math.round((todayAttendanceCount / totalStudents) * 100) : 0;
            
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('todayAttendance').textContent = todayAttendanceCount;
            document.getElementById('attendancePercentage').textContent = percentage + '%';
            
            // Update records table
            updateRecordsTable();
            updateGroupFilter();
            updateStudentFilter();
        }

        function updateStudentFilter() {
            // Update group filter for student selection
            const groupSelect = document.getElementById('studentGroupFilter');
            groupSelect.innerHTML = '<option value="">Semua Kumpulan</option>';
            
            Object.keys(studentData).forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                groupSelect.appendChild(option);
            });
            
            // Update student list
            updateStudentList();
        }

        function updateStudentList() {
            const selectedGroup = document.getElementById('studentGroupFilter').value;
            const studentSelect = document.getElementById('studentFilter');
            studentSelect.innerHTML = '<option value="">Pilih Pelajar...</option>';
            
            if (selectedGroup) {
                // Show students from selected group only
                if (studentData[selectedGroup]) {
                    studentData[selectedGroup].forEach(student => {
                        const option = document.createElement('option');
                        option.value = `${student}|${selectedGroup}`;
                        option.textContent = student;
                        studentSelect.appendChild(option);
                    });
                }
            } else {
                // Show all students from all groups
                Object.keys(studentData).forEach(group => {
                    studentData[group].forEach(student => {
                        const option = document.createElement('option');
                        option.value = `${student}|${group}`;
                        option.textContent = `${student} (${group})`;
                        studentSelect.appendChild(option);
                    });
                });
            }
        }

        function searchStudent(event) {
            const searchTerm = event.target.value.toLowerCase();
            const studentSelect = document.getElementById('studentFilter');
            const selectedGroup = document.getElementById('studentGroupFilter').value;
            
            // Clear current options
            studentSelect.innerHTML = '<option value="">Pilih Pelajar...</option>';
            
            if (searchTerm.length === 0) {
                // If search is empty, show all students based on group filter
                updateStudentList();
                return;
            }
            
            // Search through students
            let foundStudents = [];
            
            if (selectedGroup) {
                // Search within selected group
                if (studentData[selectedGroup]) {
                    studentData[selectedGroup].forEach(student => {
                        if (student.toLowerCase().includes(searchTerm)) {
                            foundStudents.push({student, group: selectedGroup});
                        }
                    });
                }
            } else {
                // Search all groups
                Object.keys(studentData).forEach(group => {
                    studentData[group].forEach(student => {
                        if (student.toLowerCase().includes(searchTerm)) {
                            foundStudents.push({student, group});
                        }
                    });
                });
            }
            
            // Add found students to dropdown
            foundStudents.forEach(({student, group}) => {
                const option = document.createElement('option');
                option.value = `${student}|${group}`;
                option.textContent = selectedGroup ? student : `${student} (${group})`;
                studentSelect.appendChild(option);
            });
            
            // If Enter key is pressed and only one result, auto-select it
            if (event.key === 'Enter' && foundStudents.length === 1) {
                studentSelect.value = `${foundStudents[0].student}|${foundStudents[0].group}`;
                updateStudentStats();
            }
        }

        function clearSearch() {
            document.getElementById('studentSearchInput').value = '';
            document.getElementById('studentGroupFilter').value = '';
            document.getElementById('studentFilter').value = '';
            document.getElementById('studentStatsDisplay').classList.add('hidden');
            updateStudentList();
        }

        function updateStudentStats() {
            const selectedValue = document.getElementById('studentFilter').value;
            const statsDisplay = document.getElementById('studentStatsDisplay');
            
            if (!selectedValue) {
                statsDisplay.classList.add('hidden');
                return;
            }
            
            const [studentName, studentGroup] = selectedValue.split('|');
            
            // Count student's attendance
            let studentAttendanceCount = 0;
            let totalPossibleClasses = 0;
            
            // Count actual attendance
            attendanceRecords.forEach(record => {
                if (record.student === studentName && record.group === studentGroup) {
                    studentAttendanceCount++;
                }
            });
            
            // Calculate total possible classes based on unique dates and times for this group
            const uniqueSessions = new Set();
            attendanceRecords.forEach(record => {
                if (record.group === studentGroup) {
                    uniqueSessions.add(`${record.date}-${record.time}`);
                }
            });
            totalPossibleClasses = uniqueSessions.size;
            
            // If no classes recorded yet, assume at least 1 for percentage calculation
            if (totalPossibleClasses === 0) {
                totalPossibleClasses = 1;
            }
            
            const attendancePercentage = Math.round((studentAttendanceCount / totalPossibleClasses) * 100);
            
            // Update display
            document.getElementById('studentGroup').textContent = studentGroup;
            document.getElementById('studentAttendanceCount').textContent = studentAttendanceCount;
            document.getElementById('studentAttendancePercentage').textContent = attendancePercentage + '%';
            
            // Show color coding for percentage
            const percentageElement = document.getElementById('studentAttendancePercentage');
            percentageElement.className = 'font-bold ';
            if (attendancePercentage >= 80) {
                percentageElement.className += 'text-green-600';
            } else if (attendancePercentage >= 60) {
                percentageElement.className += 'text-yellow-600';
            } else {
                percentageElement.className += 'text-red-600';
            }
            
            statsDisplay.classList.remove('hidden');
        }

        function updateGroupFilter() {
            const filterCourse = document.getElementById('filterCourse').value;
            const groupSelect = document.getElementById('filterGroup');
            
            groupSelect.innerHTML = '<option value="">Semua Kumpulan</option>';
            
            if (filterCourse && courseData[filterCourse]) {
                courseData[filterCourse].groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    groupSelect.appendChild(option);
                });
            } else {
                // Show all groups
                Object.values(courseData).forEach(course => {
                    course.groups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group;
                        option.textContent = group;
                        groupSelect.appendChild(option);
                    });
                });
            }
        }

        function updateGroupStats() {
            const filterCourse = document.getElementById('filterCourse').value;
            const filterGroup = document.getElementById('filterGroup').value;
            
            let filteredRecords = attendanceRecords;
            
            if (filterCourse) {
                filteredRecords = filteredRecords.filter(record => record.course === filterCourse);
            }
            if (filterGroup) {
                filteredRecords = filteredRecords.filter(record => record.group === filterGroup);
            }
            
            const groupStats = {};
            
            // Calculate stats for each group
            filteredRecords.forEach(record => {
                if (!groupStats[record.group]) {
                    groupStats[record.group] = {
                        group: record.group,
                        course: record.course,
                        attendance: 0,
                        students: new Set(),
                        dates: new Set()
                    };
                }
                groupStats[record.group].attendance++;
                groupStats[record.group].students.add(record.student);
                groupStats[record.group].dates.add(record.date);
            });
            
            // Display group statistics
            const container = document.getElementById('groupStatsContainer');
            let html = '<div class="overflow-x-auto"><table class="w-full border-collapse border border-gray-300">';
            html += '<thead><tr class="bg-purple-200">';
            html += '<th class="border border-gray-300 px-4 py-2 text-left">Kumpulan</th>';
            html += '<th class="border border-gray-300 px-4 py-2 text-left">Kursus</th>';
            html += '<th class="border border-gray-300 px-4 py-2 text-left">Jumlah Pelajar</th>';
            html += '<th class="border border-gray-300 px-4 py-2 text-left">Pelajar Hadir</th>';
            html += '<th class="border border-gray-300 px-4 py-2 text-left">Total Kehadiran</th>';
            html += '<th class="border border-gray-300 px-4 py-2 text-left">Peratus Kehadiran</th>';
            html += '</tr></thead><tbody>';
            
            if (Object.keys(groupStats).length === 0) {
                html += '<tr><td colspan="6" class="border border-gray-300 px-4 py-2 text-center text-gray-500">Tiada data kehadiran</td></tr>';
            } else {
                Object.values(groupStats).forEach(group => {
                    const totalStudents = studentData[group.group] ? studentData[group.group].length : 0;
                    const attendedStudents = group.students.size;
                    const percentage = totalStudents > 0 ? Math.round((attendedStudents / totalStudents) * 100) : 0;
                    
                    html += '<tr>';
                    html += `<td class="border border-gray-300 px-4 py-2 font-semibold">${group.group}</td>`;
                    html += `<td class="border border-gray-300 px-4 py-2">${group.course}</td>`;
                    html += `<td class="border border-gray-300 px-4 py-2">${totalStudents}</td>`;
                    html += `<td class="border border-gray-300 px-4 py-2">${attendedStudents}</td>`;
                    html += `<td class="border border-gray-300 px-4 py-2">${group.attendance}</td>`;
                    html += `<td class="border border-gray-300 px-4 py-2">`;
                    html += `<span class="px-2 py-1 rounded ${percentage >= 80 ? 'bg-green-100 text-green-800' : percentage >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">${percentage}%</span>`;
                    html += `</td>`;
                    html += '</tr>';
                });
            }
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function updateRecordFilters() {
            const selectedCourse = document.getElementById('recordFilterCourse').value;
            const groupSelect = document.getElementById('recordFilterGroup');
            const timeSelect = document.getElementById('recordFilterTime');
            
            // Update group options based on selected course
            groupSelect.innerHTML = '<option value="">Semua Kumpulan</option>';
            timeSelect.innerHTML = '<option value="">Semua Masa</option>';
            
            if (selectedCourse && courseData[selectedCourse]) {
                // Add groups for selected course
                courseData[selectedCourse].groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    groupSelect.appendChild(option);
                });
                
                // Add time slots for selected course
                courseData[selectedCourse].schedule.forEach(time => {
                    const option = document.createElement('option');
                    option.value = time;
                    option.textContent = time;
                    timeSelect.appendChild(option);
                });
            } else {
                // Add all groups and times
                Object.values(courseData).forEach(course => {
                    course.groups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group;
                        option.textContent = group;
                        groupSelect.appendChild(option);
                    });
                    
                    course.schedule.forEach(time => {
                        if (!Array.from(timeSelect.options).some(opt => opt.value === time)) {
                            const option = document.createElement('option');
                            option.value = time;
                            option.textContent = time;
                            timeSelect.appendChild(option);
                        }
                    });
                });
            }
            
            updateRecordsTable();
        }

        function updateRecordsTable() {
            const container = document.getElementById('recordsTableContainer');
            const filterCourse = document.getElementById('recordFilterCourse').value;
            const filterGroup = document.getElementById('recordFilterGroup').value;
            const filterTime = document.getElementById('recordFilterTime').value;
            const filterDate = document.getElementById('recordFilterDate').value;
            
            // Check if any filter is applied
            const hasFilters = filterCourse || filterGroup || filterTime || filterDate;
            
            if (!hasFilters) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p class="text-lg">🔍 Sila pilih filter untuk melihat rekod kehadiran</p>
                        <p class="text-sm mt-2">Gunakan dropdown di atas untuk filter mengikut kursus, kumpulan, masa atau tarikh</p>
                    </div>
                `;
                return;
            }
            
            // Filter records based on selected criteria
            let filteredRecords = attendanceRecords;
            
            if (filterCourse) {
                filteredRecords = filteredRecords.filter(record => record.course === filterCourse);
            }
            if (filterGroup) {
                filteredRecords = filteredRecords.filter(record => record.group === filterGroup);
            }
            if (filterTime) {
                filteredRecords = filteredRecords.filter(record => record.time === filterTime);
            }
            if (filterDate) {
                filteredRecords = filteredRecords.filter(record => record.date === filterDate);
            }
            
            // Sort records by date (newest first)
            const sortedRecords = [...filteredRecords].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            // Create table
            let html = `
                <table class="w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="border border-gray-300 px-4 py-2 text-left">Kursus</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">Kumpulan</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">Nama Pelajar</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">Masa</th>
                            <th class="border border-gray-300 px-4 py-2 text-left">Tarikh</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (sortedRecords.length === 0) {
                html += '<tr><td colspan="5" class="border border-gray-300 px-4 py-2 text-center text-gray-500">Tiada rekod kehadiran ditemui untuk filter yang dipilih</td></tr>';
            } else {
                sortedRecords.forEach(record => {
                    html += `
                        <tr>
                            <td class="border border-gray-300 px-4 py-2">${record.course}</td>
                            <td class="border border-gray-300 px-4 py-2">${record.group}</td>
                            <td class="border border-gray-300 px-4 py-2">${record.student}</td>
                            <td class="border border-gray-300 px-4 py-2">${record.time}</td>
                            <td class="border border-gray-300 px-4 py-2">${record.date}</td>
                        </tr>
                    `;
                });
            }
            
            html += '</tbody></table>';
            
            // Add summary info
            const summaryHtml = `
                <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <p class="text-sm text-blue-800">
                        <strong>Hasil Filter:</strong> ${sortedRecords.length} rekod kehadiran ditemui
                        ${filterCourse ? ` | Kursus: ${filterCourse}` : ''}
                        ${filterGroup ? ` | Kumpulan: ${filterGroup}` : ''}
                        ${filterTime ? ` | Masa: ${filterTime}` : ''}
                        ${filterDate ? ` | Tarikh: ${filterDate}` : ''}
                    </p>
                </div>
            `;
            
            container.innerHTML = summaryHtml + html;
        }

        function clearRecordFilters() {
            document.getElementById('recordFilterCourse').value = '';
            document.getElementById('recordFilterGroup').value = '';
            document.getElementById('recordFilterTime').value = '';
            document.getElementById('recordFilterDate').value = '';
            
            // Reset group and time options
            updateRecordFilters();
        }

        function exportFilteredRecords() {
            const filterCourse = document.getElementById('recordFilterCourse').value;
            const filterGroup = document.getElementById('recordFilterGroup').value;
            const filterTime = document.getElementById('recordFilterTime').value;
            const filterDate = document.getElementById('recordFilterDate').value;
            
            // Check if any filter is applied
            const hasFilters = filterCourse || filterGroup || filterTime || filterDate;
            
            if (!hasFilters) {
                alert('Sila pilih sekurang-kurangnya satu filter sebelum export.');
                return;
            }
            
            // Filter records
            let filteredRecords = attendanceRecords;
            
            if (filterCourse) {
                filteredRecords = filteredRecords.filter(record => record.course === filterCourse);
            }
            if (filterGroup) {
                filteredRecords = filteredRecords.filter(record => record.group === filterGroup);
            }
            if (filterTime) {
                filteredRecords = filteredRecords.filter(record => record.time === filterTime);
            }
            if (filterDate) {
                filteredRecords = filteredRecords.filter(record => record.date === filterDate);
            }
            
            if (filteredRecords.length === 0) {
                alert('Tiada data untuk diexport berdasarkan filter yang dipilih.');
                return;
            }
            
            // Prepare CSV data
            let csvContent = 'Kursus,Kumpulan,Nama Pelajar,Masa,Tarikh\n';
            
            filteredRecords.forEach(record => {
                csvContent += `${record.course},${record.group},${record.student},${record.time},${record.date}\n`;
            });
            
            // Create downloadable CSV file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                
                // Create filename based on filters
                let filename = 'filtered_attendance';
                if (filterCourse) filename += `_${filterCourse}`;
                if (filterGroup) filename += `_${filterGroup}`;
                if (filterDate) filename += `_${filterDate}`;
                filename += '.csv';
                
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`${filteredRecords.length} rekod kehadiran telah diexport sebagai ${filename}`);
            } else {
                alert('Browser anda tidak menyokong download automatik.');
            }
        }

        function exportToSheets() {
            if (attendanceRecords.length === 0) {
                alert('Tiada data kehadiran untuk diexport.');
                return;
            }
            
            // Prepare CSV data
            let csvContent = 'Kursus,Kumpulan,Nama Pelajar,Masa,Tarikh\n';
            
            attendanceRecords.forEach(record => {
                csvContent += `${record.course},${record.group},${record.student},${record.time},${record.date}\n`;
            });
            
            // Create downloadable CSV file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'attendance_data.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('Data kehadiran telah diexport sebagai CSV. Sila upload fail ini ke Google Sheets anda.');
            } else {
                alert('Browser anda tidak menyokong download automatik. Sila salin data dari jadual rekod kehadiran.');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
        
        // Also initialize immediately if DOM is already loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98899e9c92773c47',t:'MTc1OTQ2NDkzOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
